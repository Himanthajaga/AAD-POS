<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
          integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
</head>
<body>
<div class="container mt-5">
    <h2>Place Order</h2>
    <form id="orderForm">
        <div class="mb-3">
            <label for="orderId" class="form-label">Order ID</label>
            <input type="text" class="form-control" id="orderId" required>
        </div>
        <div class="mb-3">
            <label for="orderDate" class="form-label">Order Date</label>
            <input type="date" class="form-control" id="orderDate" required>
        </div>
        <div class="mb-3">
            <label for="customerId" class="form-label">Customer ID</label>
            <select class="form-select" id="customerId" required>
                <!-- Options will be populated dynamically -->
            </select>
        </div>
        <div class="mb-3">
            <label for="customerName" class="form-label">Customer Name</label>
            <input type="text" class="form-control" id="customerName" readonly>
        </div>
        <div class="mb-3">
            <label for="items" class="form-label">Items</label>
            <select class="form-select" id="items" required>
                <!-- Options will be populated dynamically -->
            </select>
            <div class="mb-3">
                <label for="ItemName" class="form-label">Item Description</label>
                <input type="text" class="form-control" id="ItemName" readonly>
            </div>
            <div class="mb-3">
                <label for="itemQuantity" class="form-label">Quantity</label>
                <input type="number" class="form-control" id="itemQuantity" placeholder="Quantity" required>
            </div>
            <button type="button" class="btn btn-secondary mt-2" id="addItem">Add Item</button>
        </div>
        <table class="table mt-3">
            <thead>
            <tr>
                <th>Item Name</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total Price</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="orderItemsTable">
            <!-- Items will be added here dynamically -->
            </tbody>
        </table>
        <div class="mb-3">
            <label for="totalPrice" class="form-label">Total Price</label>
            <input type="text" class="form-control" id="totalPrice" readonly>
        </div>
        <button type="submit" class="btn btn-primary">Place Order</button>
    </form>
</div>

<script src="js/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(() => {
        let customers = [];
        let itemsData = [];

        // Fetch customers and populate the customerId dropdown
        $.ajax({
            url: "http://localhost:8080/Application1_Web_exploded/customer",
            type: "GET",
            success: (data) => {
                customers = data;
                customers.forEach(customer => {
                    $('#customerId').append(new Option(customer.id, customer.id));
                });
            },
            error: (err) => console.error("Error fetching customers:", err)
        });

        // Auto-fill customer name when customer ID is selected
        $('#customerId').change(() => {
            const selectedCustomerId = $('#customerId').val();
            const selectedCustomer = customers.find(customer => customer.id === selectedCustomerId);
            $('#customerName').val(selectedCustomer ? selectedCustomer.name : '');
        });

        // Fetch items and populate the items dropdown
        $.ajax({
            url: "http://localhost:8080/Application1_Web_exploded/item",
            type: "GET",
            success: (items) => {
                itemsData = items;
                $('#items').empty();
                items.forEach(item => {
                    $('#items').append(new Option(item.code, item.id));
                });
            },
            error: (err) => console.error("Error fetching items:", err)
        });

        // Auto-fill item description when item code is selected
        $('#items').change(() => {
            const selectedItemId = $('#items').val();
            const selectedItem = itemsData.find(item => item.id === selectedItemId);
            $('#ItemName').val(selectedItem ? selectedItem.description : '');
        });

        // Add item to table with quantity validation
        $('#addItem').click(() => {
            const itemId = $('#items').val();
            const quantity = parseInt($('#itemQuantity').val(), 10);

            if (isNaN(quantity) || quantity <= 0) {
                alert("Please enter a valid quantity.");
                return;
            }

            const item = itemsData.find(item => item.id === itemId);
            const unitPrice = item ? item.unitPrice : 0;
            const totalPrice = unitPrice * quantity;

            $('#orderItemsTable').append(`
            <tr>
                <td>${item.description}</td>
                <td>${quantity}</td>
                <td>${unitPrice.toFixed(2)}</td>
                <td>${totalPrice.toFixed(2)}</td>
                <td><button type="button" class="btn btn-danger btn-sm remove-item">Remove</button></td>
            </tr>
        `);

            // Clear item fields
            $('#items').val('');
            $('#ItemName').val('');
            $('#itemQuantity').val('');

            calculateTotalPrice();
        });

        // Calculate total price
        const calculateTotalPrice = () => {
            let total = 0;
            $('#orderItemsTable tr').each(function() {
                const totalPrice = parseFloat($(this).find('td').eq(3).text());
                total += totalPrice;
            });
            $('#totalPrice').val(total.toFixed(2));
        };

        // Remove item from table
        $(document).on('click', '.remove-item', function() {
            $(this).closest('tr').remove();
            calculateTotalPrice();
        });
    });
</script>
</body>
</html>